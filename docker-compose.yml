services:
  app:
    image: "jc21/nginx-proxy-manager:latest"
    restart: always
    ports:
      - "80:80"
      - "443:443"
      # Admin Web Port:
      - "127.0.0.1:81:81"
    volumes:
      - data:/data
      - letsencrypt:/etc/letsencrypt
      - ssl:/srv/ssl:ro
      - ca:/srv/ca:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    configs:
      - source: http
        target: /data/nginx/custom/http.conf
      - source: server_proxy
        target: /data/nginx/custom/server_proxy.conf
    depends_on:
      - db
      - ssl
    environment:
      # Postgres parameters:
      DB_POSTGRES_HOST: 'db'
      DB_POSTGRES_NAME: 'npm'
      DB_POSTGRES_PASSWORD: "${DB_PASSWORD:-kMm0rB8GMzhF9gD$!}"
      DB_POSTGRES_PORT: '5432'
      DB_POSTGRES_USER: 'npm'
      # Uncomment this if IPv6 is not enabled on your host
      # DISABLE_IPV6: 'true'

  db:
    image: postgres:latest
    restart: always
    environment:
      POSTGRES_DB: 'npm'
      POSTGRES_PASSWORD: "${DB_PASSWORD:-kMm0rB8GMzhF9gD$!}"
      POSTGRES_USER: 'npm'
    volumes:
      - postgres:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 3s
      retries: 10

  ssl:
    image: alpine/openssl:latest
    restart: "no"
    volumes:
      - ssl:/srv/ssl
      - ca:/srv/ca
    environment:
      - SERVER_SAN_EXTRA
    configs:
      - source: ssl_params
        target: /opt/ssl_params.sh
    entrypoint: ""
    command:
      - /bin/sh
      - -c
      - |
        set -e
        . /opt/ssl_params.sh
        SERVER_SAN="DNS:$${SERVER_COMMON_NAME},DNS:*.$${SERVER_COMMON_NAME}"
        # Optional extra SANs validation (comma-separated; tokens like DNS:name or IP:addr)
        if [ -n "$$SERVER_SAN_EXTRA" ]; then
          echo "[ssl] INFO: adding extra SANs: '$$SERVER_SAN_EXTRA'"
          EXTRA_CLEAN="$(echo "$$SERVER_SAN_EXTRA" | tr -d '[:space:]')"
          EXTRA_VALID=""
          OLD_IFS="$$IFS"; IFS=,
          for tok in $$EXTRA_CLEAN; do
            case "$$tok" in
              DNS:*|IP:*)
                if [ -z "$$EXTRA_VALID" ]; then EXTRA_VALID="$$tok"; else EXTRA_VALID="$$EXTRA_VALID,$$tok"; fi
                ;;
              *)
                echo "[ssl] WARN: invalid SAN token skipped: '$$tok'" >&2
                ;;
            esac
          done
          IFS="$$OLD_IFS"
          [ -n "$$EXTRA_VALID" ] && SERVER_SAN="$$SERVER_SAN,$$EXTRA_VALID"
        fi
        openssl version -a

        # Generate CA if missing or empty
        if [ ! -s /srv/ca/ca.pem ] || [ ! -s /srv/ca/ca.key ]; then
          rm -f /srv/ca/ca.pem /srv/ca/ca.srl
          openssl ecparam -name "$$DEFAULT_EC_CURVE" -genkey -noout -out /srv/ca/ca.key
          openssl req -verbose -x509 -new -key /srv/ca/ca.key -days $$DEFAULT_VALID_DAYS -sha384 -utf8 \
            -subj "/C=$$DEFAULT_COUNTRY/ST=$$DEFAULT_STATE/L=$$DEFAULT_LOCALITY/O=$$DEFAULT_ORGANIZATION/OU=$$DEFAULT_ORGANIZATIONAL_UNIT/CN=$$CA_COMMON_NAME" \
            -out /srv/ca/ca.pem
        fi

        # Generate server key if missing or empty; create CSR
        if [ ! -s /srv/ssl/privkey.pem ]; then
          openssl ecparam -name "$$DEFAULT_EC_CURVE" -genkey -noout -out /srv/ssl/privkey.pem
        fi
        openssl req -verbose -new -utf8 \
          -subj "/C=$$DEFAULT_COUNTRY/ST=$$DEFAULT_STATE/L=$$DEFAULT_LOCALITY/O=$$DEFAULT_ORGANIZATION/OU=$$DEFAULT_ORGANIZATIONAL_UNIT/CN=$$SERVER_COMMON_NAME" \
          -key /srv/ssl/privkey.pem -out /tmp/server.csr

        printf "basicConstraints=CA:FALSE\nkeyUsage=digitalSignature\nextendedKeyUsage=serverAuth,clientAuth\nsubjectAltName=$$SERVER_SAN\n" > /tmp/ext.cnf
        rm -f /srv/ssl/cert.pem
        openssl x509 -req -in /tmp/server.csr -CA /srv/ca/ca.pem -CAkey /srv/ca/ca.key -CAcreateserial -CAserial /srv/ca/ca.srl \
          -out /srv/ssl/cert.pem -days $$DEFAULT_VALID_DAYS -extfile /tmp/ext.cnf -sha384

        rm -f /tmp/server.csr /tmp/ext.cnf
        ls -l /srv/ca /srv/ssl

  portainer:
    image: portainer/portainer-ce:latest
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer:/data
    command: --http-enabled
    depends_on:
      - app

  watchtower:
    image: nickfedor/watchtower:latest
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_POLL_INTERVAL=10800
      - WATCHTOWER_NOTIFICATIONS=${WATCHTOWER_NOTIFICATIONS:-}
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}
      - WATCHTOWER_NOTIFICATIONS_HOSTNAME=${WATCHTOWER_NOTIFICATIONS_HOSTNAME:-}
      - TZ=${TZ:-UTC}
    command: --no-color

volumes:
  postgres:
  data:
  letsencrypt:
  ssl:
  ca:
  portainer:

configs:
  http:
    content: |
      server {
        set $$forward_scheme http;
        set $$server         "127.0.0.1";
        set $$port           81;

        listen 80;
        listen [::]:80;

        server_name local.test;

        proxy_set_header Upgrade $$http_upgrade;
        proxy_set_header Connection $$http_connection;
        proxy_http_version 1.1;

        access_log /data/logs/npm_access.log proxy;
        error_log /data/logs/npm_error.log warn;

        location = /ca.pem {
          alias /srv/ca/ca.pem;
          default_type application/x-x509-ca-cert;
          add_header Content-Disposition 'attachment; filename="ca.pem"';
        }

        location / {
          proxy_set_header Upgrade $$http_upgrade;
          proxy_set_header Connection $$http_connection;
          proxy_http_version 1.1;

          # Proxy!
          include conf.d/include/proxy.conf;
        }

        # Custom
        include /data/nginx/custom/server_proxy[.]conf;
      }
      server {
        set $$forward_scheme http;
        set $$server         "portainer";
        set $$port           9000;

        listen 80;
        listen [::]:80;

        server_name portainer.local.test;

        proxy_set_header Upgrade $$http_upgrade;
        proxy_set_header Connection $$http_connection;
        proxy_http_version 1.1;

        access_log /data/logs/portainer_access.log proxy;
        error_log /data/logs/portainer_error.log warn;

        location / {
          proxy_set_header Upgrade $$http_upgrade;
          proxy_set_header Connection $$http_connection;
          proxy_http_version 1.1;

          # Proxy!
          include conf.d/include/proxy.conf;
        }

        # Custom
        include /data/nginx/custom/server_proxy[.]conf;
      }

  server_proxy:
    content: |
      listen 443 ssl;
      listen [::]:443 ssl;

      # Custom SSL
      ssl_certificate /srv/ssl/cert.pem;
      ssl_certificate_key /srv/ssl/privkey.pem;

      # Force SSL
      include conf.d/include/force-ssl.conf;

  ssl_params:
    content: |
      # Default parameters
      DEFAULT_EC_CURVE="prime256v1"
      DEFAULT_VALID_DAYS=365
      DEFAULT_COUNTRY="XX"
      DEFAULT_STATE="Nowhere"
      DEFAULT_LOCALITY="Unknown"
      DEFAULT_ORGANIZATION="LocalDev"
      DEFAULT_ORGANIZATIONAL_UNIT="Dev"

      # CA
      CA_COMMON_NAME="Local Test"

      # Server
      SERVER_COMMON_NAME="local.test"
